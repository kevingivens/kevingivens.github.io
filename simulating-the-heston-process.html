<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Simulating the Heston Process - Lost in the Lyceum</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="/theme/images/icons/favicon.ico" rel="icon">

<link rel="canonical" href="/simulating-the-heston-process.html">

        <meta name="author" content="Kevin Givens" />
        <meta name="keywords" content="Numerical Methods,QuantLib" />
        <meta name="description" content="Summary: We investigate different discretization schemes for the Heston Process, looking at issues of numerical bias and ease of implementation In today&#39;s post, I will examine a few issues related to numerical simulation of the Heston model. As a quick reminder, the Heston process is a stochastic volatility model defined …" />

        <meta property="og:site_name" content="Lost in the Lyceum" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Simulating the Heston Process"/>
        <meta property="og:url" content="/simulating-the-heston-process.html"/>
        <meta property="og:description" content="Summary: We investigate different discretization schemes for the Heston Process, looking at issues of numerical bias and ease of implementation In today&#39;s post, I will examine a few issues related to numerical simulation of the Heston model. As a quick reminder, the Heston process is a stochastic volatility model defined …"/>
        <meta property="article:published_time" content="2018-04-29" />
            <meta property="article:section" content="Finance" />
            <meta property="article:tag" content="Numerical Methods" />
            <meta property="article:tag" content="QuantLib" />
            <meta property="article:author" content="Kevin Givens" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/default.css" rel="stylesheet">
    <link href="/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>



</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Lost in the Lyceum            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="/pages/about.html">
                             About
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/simulating-the-heston-process.html"
                       rel="bookmark"
                       title="Permalink to Simulating the Heston Process">
                        Simulating the Heston Process
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-04-29T10:20:00-04:00"> Sun 29 April 2018</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="/tag/numerical-methods.html">Numerical Methods</a>
        /
	<a href="/tag/quantlib.html">QuantLib</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Summary: We investigate different discretization schemes for the Heston Process, looking at issues of numerical bias and
ease of implementation</p>
<p>In today's post, I will examine a few issues related to numerical simulation of the Heston model.
As a quick reminder, the Heston process is a stochastic volatility model defined by the
following sde:</p>
<div class="math">$$
dS_t = (r-d) S_t dt + \sqrt{V_t} S_t dW^s_t
$$</div>
<div class="math">$$
dV_t = \kappa (\theta - V_t) dt + \sigma \sqrt{V_t} dW^\upsilon_t
$$</div>
<div class="math">$$
dW^s_t dW^\upsilon_t = \rho dt
$$</div>
<p>for asset price <span class="math">\(S_t\)</span>. <span class="math">\(dW_t^s\)</span> and <span class="math">\(dW_t^{\nu}\)</span> are Wiener processes with correlation <span class="math">\(\rho\)</span>.  As usual, <span class="math">\(r\)</span> and <span class="math">\(d\)</span> are the risk free and dividend rates respectively.</p>
<p>The Heston model is an excellent benchmarking model due to the suprising fact that
that it's probability distribution function (pdf) has a closed formed expression.  It's a one
of five such processes in 1 or 2 dimensions <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=773568">PHL</a>.  With the closed form pdf, we can easily compare the performance of the Heston model's numerical simulation by
comparing PV's of a Monte Carlo pricer with an analytic pricer.</p>
<p>To carry out a numerical simulation we first need to choose a discretization scheme. That is, we need to approximate the infinitesimal diffusion process with a finite scheme to be used in the simulation code.  Any such scheme may potentially introduce bias into the simulation that could alter the realized moments of the pdf.</p>
<p>The simplest possible scheme is a first order expansion, i.e. an Euler Mayorana (or just ''Euler'') scheme.  Transforming to <span class="math">\(\ln S\)</span> and discretizing <span class="math">\(t\)</span> to step size <span class="math">\(\Delta\)</span> gives</p>
<div class="math">$$
\ln S(t + \Delta) = \ln S(t) + \left(r - d - \frac{1}{2}V(t)\right)\Delta +\sqrt{V(t)} Z_S\sqrt{\Delta}
$$</div>
<div class="math">$$
V(t + \Delta) = V(t) + \kappa\left(\theta - V(t)\right)\Delta + \sigma \sqrt{V(t)} Z_V \sqrt{\Delta}
$$</div>
<p>However, it turns out that this scheme does introduce bias.  Furthermore, in this scheme it's possible to drive the variance process to negative values, which is outside the range of the pdf and causes the simulation to stop as <span class="math">\(\sqrt{V}\)</span> becomes imaginary.</p>
<p>One immediate fix to this problem is the floor V at 0, giving the so called "Truncated" scheme.
Other schemes are based on higher order expansions of the sde or utilizing the closed form
expression for the pdf. These are documented extensively in the literature <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=946405">Anderson</a>.  We list some of the schemes below</p>
<ol>
<li>Euler Mayorana</li>
<li>Truncated</li>
<li>Quadratic Exponential</li>
<li>Broadie Kaya (Exact Simulation)</li>
</ol>
<p>Broadie Kaya is based off direct sampling from the pdf but is rather difficult to implement numerically.  The Quadratic Exponential (developed in <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=946405">Anderson</a>) approximates the pdf using simplified functions and moment matching.  The pdf for high and low values of the variance are matched against two different functions and threshold is implemented to switch between the two functions during a diffusion.  This technique allows one to minimize variance while also easing the numerical implementation.  As such, this scheme it is often the preferred scheme for Heston simulations.    </p>
<h2>QuantLib Implementation</h2>
<p>QuantLib includes several of these discretization schemes in their
Heston Process class.  Let's see what a simulation looks like.</p>
<p>Quick note: Although the HestonProcess class is available through the SWIG bindings,
it does not expose the discretizations argument.  Instead, we use <a href="https://github.com/enthought/pyql">PyQL</a>,
which has all the discretizations available.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">quantlib.processes.heston_process</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">quantlib.quotes</span> <span class="kn">import</span> <span class="n">SimpleQuote</span>
<span class="kn">from</span> <span class="nn">quantlib.settings</span> <span class="kn">import</span> <span class="n">Settings</span>
<span class="kn">from</span> <span class="nn">quantlib.termstructures.yields.flat_forward</span> <span class="kn">import</span> <span class="n">FlatForward</span>
<span class="kn">from</span> <span class="nn">quantlib.time.api</span> <span class="kn">import</span> <span class="n">today</span><span class="p">,</span> <span class="n">TARGET</span><span class="p">,</span> <span class="n">ActualActual</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">Period</span><span class="p">,</span> <span class="n">Years</span>
<span class="kn">from</span> <span class="nn">quantlib.models.equity.heston_model</span> <span class="kn">import</span> <span class="p">(</span><span class="n">HestonModel</span><span class="p">,</span>
                                                 <span class="n">HestonModelHelper</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">quantlib.pricingengines.api</span> <span class="kn">import</span> <span class="p">(</span><span class="n">AnalyticHestonEngine</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">quantlib.pricingengines.vanilla.mceuropeanhestonengine</span> <span class="kn">import</span> <span class="n">MCEuropeanHestonEngine</span>
<span class="kn">from</span> <span class="nn">quantlib.instruments.api</span> <span class="kn">import</span> <span class="p">(</span><span class="n">PlainVanillaPayoff</span><span class="p">,</span>
                                      <span class="n">EuropeanExercise</span><span class="p">,</span>
                                      <span class="n">VanillaOption</span><span class="p">,</span>
                                      <span class="n">EuropeanOption</span><span class="p">)</span>
</pre></div>


<h2>Defining the Heston Process</h2>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">flat_rate</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">daycounter</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">FlatForward</span><span class="p">(</span>
        <span class="n">forward</span> <span class="o">=</span> <span class="n">forward</span><span class="p">,</span>
        <span class="n">settlement_days</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">calendar</span> <span class="o">=</span> <span class="n">TARGET</span><span class="p">(),</span>
        <span class="n">daycounter</span> <span class="o">=</span> <span class="n">daycounter</span>
    <span class="p">)</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<span class="n">settlement_date</span> <span class="o">=</span> <span class="n">today</span><span class="p">()</span>
<span class="n">settings</span><span class="o">.</span><span class="n">evaluation_date</span> <span class="o">=</span> <span class="n">settlement_date</span>

<span class="n">day_counter</span> <span class="o">=</span> <span class="n">ActualActual</span><span class="p">()</span>
<span class="n">interest_rate</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">dividend_yield</span> <span class="o">=</span> <span class="mf">0.4</span>

<span class="n">risk_free_ts</span> <span class="o">=</span> <span class="n">flat_rate</span><span class="p">(</span><span class="n">interest_rate</span><span class="p">,</span> <span class="n">day_counter</span><span class="p">)</span>
<span class="n">dividend_ts</span> <span class="o">=</span> <span class="n">flat_rate</span><span class="p">(</span><span class="n">dividend_yield</span><span class="p">,</span> <span class="n">day_counter</span><span class="p">)</span>

<span class="n">maturity</span> <span class="o">=</span> <span class="n">Period</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Years</span><span class="p">)</span>
<span class="n">exercise_date</span> <span class="o">=</span> <span class="n">settlement_date</span> <span class="o">+</span> <span class="n">maturity</span>

<span class="c1"># spot</span>
<span class="n">s0</span> <span class="o">=</span> <span class="n">SimpleQuote</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>

<span class="c1"># Available descritizations</span>
<span class="c1">#PARTIALTRUNCATION</span>
<span class="c1">#FULLTRUNCATION</span>
<span class="c1">#REFLECTION</span>
<span class="c1">#NONCENTRALCHISQUAREVARIANCE</span>
<span class="c1">#QUADRATICEXPONENTIAL</span>
<span class="c1">#QUADRATICEXPONENTIALMARTINGALE</span>
<span class="c1">#BROADIEKAYAEXACTSCHEMELOBATTO</span>
<span class="c1">#BROADIEKAYAEXACTSCHEMELAGUERRE</span>
<span class="c1">#BROADIEKAYAEXACTSCHEMETRAPEZOIDAL</span>

<span class="c1"># Heston Model params</span>
<span class="n">v0</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">kappa</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.0e-4</span>
<span class="n">rho</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>

<span class="k">def</span> <span class="nf">gen_process</span><span class="p">(</span><span class="n">desc</span><span class="p">):</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">HestonProcess</span><span class="p">(</span><span class="n">risk_free_ts</span><span class="p">,</span>
                            <span class="n">dividend_ts</span><span class="p">,</span>
                            <span class="n">s0</span><span class="p">,</span>
                            <span class="n">v0</span><span class="p">,</span>
                            <span class="n">kappa</span><span class="p">,</span>
                            <span class="n">theta</span><span class="p">,</span>
                            <span class="n">sigma</span><span class="p">,</span>
                            <span class="n">rho</span><span class="p">,</span>
                            <span class="n">desc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process</span>

<span class="n">processes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;REFLECTION&quot;</span> <span class="p">:</span> <span class="n">gen_process</span><span class="p">(</span><span class="n">REFLECTION</span><span class="p">),</span>
  <span class="s2">&quot;PARTIALTRUNCATION&quot;</span> <span class="p">:</span> <span class="n">gen_process</span><span class="p">(</span><span class="n">PARTIALTRUNCATION</span><span class="p">),</span>
  <span class="s2">&quot;QUADRATICEXPONENTIAL&quot;</span> <span class="p">:</span> <span class="n">gen_process</span><span class="p">(</span><span class="n">QUADRATICEXPONENTIAL</span><span class="p">),</span>
  <span class="s2">&quot;QUADRATICEXPONENTIALMARTINGALE&quot;</span> <span class="p">:</span> <span class="n">gen_process</span><span class="p">(</span><span class="n">QUADRATICEXPONENTIALMARTINGALE</span><span class="p">),</span>
<span class="p">}</span>
</pre></div>


<h2>Visualizing the Simulation</h2>
<p>Note: The <em>simulate</em> function is not part of Quantlib. It has been added to the PyQL interface (see folder <a href="https://github.com/enthought/pyql/tree/master/quantlib/sim">quantlib/sim</a>).</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">quantlib.sim.simulate</span> <span class="kn">import</span> <span class="n">simulate_process</span>
<span class="kn">from</span> <span class="nn">quantlib.time_grid</span> <span class="kn">import</span> <span class="n">TimeGrid</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;axes.facecolor&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)})</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># simulate and plot Heston paths</span>
<span class="n">paths</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">horizon</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">154</span>

<span class="n">grid</span> <span class="o">=</span> <span class="n">TimeGrid</span><span class="p">(</span><span class="n">horizon</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">flat_axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">processes</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">flat_axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">grid</span><span class="p">),</span> <span class="n">simulate_process</span><span class="p">(</span><span class="n">processes</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">paths</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">seed</span><span class="p">))</span>
    <span class="n">flat_axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
    <span class="n">flat_axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Stock Price&#39;</span><span class="p">)</span>
    <span class="n">flat_axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="/HestonSimulation_files/HestonSimulation_8_0.png"></p>
<p>Let's look at of the diffusions in detail, for example the evolution of the Heston process using Partial Truncation looks like this</p>
<div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">simulate_process</span><span class="p">(</span><span class="n">processes</span><span class="p">[</span><span class="s2">&quot;PARTIALTRUNCATION&quot;</span><span class="p">],</span> <span class="n">paths</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">res</span><span class="p">[[</span><span class="mi">25</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">75</span><span class="p">,</span><span class="mi">100</span><span class="p">],:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">paths</span><span class="p">)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="s2">&quot;T=0.5&quot;</span><span class="p">,</span><span class="s2">&quot;T=1.0&quot;</span><span class="p">,</span><span class="s2">&quot;T=1.5&quot;</span><span class="p">,</span><span class="s2">&quot;T=2.0&quot;</span><span class="p">],</span> <span class="n">paths</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">))</span>

<span class="c1"># Initialize the FacetGrid object</span>
<span class="n">pal</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-.</span><span class="mi">25</span><span class="p">,</span> <span class="n">light</span><span class="o">=.</span><span class="mi">7</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.6</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">pal</span><span class="p">)</span>

<span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

<span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_titles</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">g</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="/HestonSimulation_files/HestonSimulation_10_1.png"></p>
<h2>Comparing the PV's of different engines</h2>
<p>To examine the performance of the numerical schemes, we simply compare the PV's
the same Call Option priced with an analytic and Monte Carlo engine.  The results
for different time steps and schemes are given in the table below</p>
<div class="highlight"><pre><span></span><span class="c1"># Build a Call Option</span>
<span class="n">payoff</span> <span class="o">=</span> <span class="n">PlainVanillaPayoff</span><span class="p">(</span><span class="s1">&#39;Call&#39;</span><span class="p">,</span> <span class="mi">105</span><span class="p">)</span>
<span class="n">exercise</span> <span class="o">=</span> <span class="n">EuropeanExercise</span><span class="p">(</span><span class="n">exercise_date</span><span class="p">)</span>
<span class="n">option</span> <span class="o">=</span> <span class="n">EuropeanOption</span><span class="p">(</span><span class="n">payoff</span><span class="p">,</span> <span class="n">exercise</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;REFLECTION&quot;</span> <span class="p">:</span> <span class="p">[],</span>
           <span class="s2">&quot;PARTIALTRUNCATION&quot;</span> <span class="p">:</span> <span class="p">[],</span>
           <span class="s2">&quot;QUADRATICEXPONENTIAL&quot;</span> <span class="p">:</span> <span class="p">[],</span>
           <span class="s2">&quot;QUADRATICEXPONENTIALMARTINGALE&quot;</span> <span class="p">:</span> <span class="p">[],</span>
<span class="p">}</span>

<span class="c1"># steps per year</span>
<span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span>

<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">processes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
        <span class="n">mc_engine</span> <span class="o">=</span> <span class="n">MCEuropeanHestonEngine</span><span class="p">(</span><span class="n">v</span><span class="p">,</span>
                                           <span class="n">steps_per_year</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
                                           <span class="n">required_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                           <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">,</span>
                                           <span class="p">)</span>
        <span class="n">option</span><span class="o">.</span><span class="n">set_pricing_engine</span><span class="p">(</span><span class="n">mc_engine</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">npv</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">error_estimate</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>


<span class="n">results</span><span class="p">[</span><span class="s2">&quot;time steps per year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">results</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>  <span class="n">cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">results_df</span>
</pre></div>


<table>
<thead>
<tr>
<th>time steps per year</th>
<th>REFLECTION</th>
<th>PARTIAL TRUNCATION</th>
<th>QUADRATIC EXPONENTIAL</th>
<th>QUADRATIC EXPONENTIAL MARTINGALE</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>(1.64404, 0.05392)</td>
<td>(1.74109, 0.03607)</td>
<td>(1.71144, 0.02744)</td>
<td>(1.71527, 0.02811)</td>
</tr>
<tr>
<td>4</td>
<td>(1.64447, 0.06608)</td>
<td>(1.74109, 0.03607)</td>
<td>(1.71144, 0.02744)</td>
<td>(1.71527, 0.02811)</td>
</tr>
<tr>
<td>8</td>
<td>(1.98966, 0.04768)</td>
<td>(1.77399, 0.03692)</td>
<td>(1.70905, 0.02727)</td>
<td>(1.73049, 0.02829)</td>
</tr>
<tr>
<td>16</td>
<td>(1.80227, 0.03563)</td>
<td>(1.75864, 0.0351)</td>
<td>(1.70581, 0.02687)</td>
<td>(1.72956, 0.02818)</td>
</tr>
</tbody>
</table>
<h2>Conclusion</h2>
<p>As we saw, there are many ways to simulate the Heston model, each with strengths and
weaknesses with regards to bias/accuracy and runtime performance.  In general, the Quadratic Exponential scheme performed better than Euler-type schemes, especially for simulations with fewer time steps per year.</p>
<p>In a future post, I will visit the local stochastic volatility version of the Heston model to see how it's simulation
works.  </p>
<h2>Is there a better way?</h2>
<p>If you take a look at the HestonProcess class file in QuantLib you will see that it,
for each discretization, there is a different diffusion implementation.
The user chooses the discretization from an enumerated list. The downside to this approach is that
, in addition to creating bloated code, the list is always finite.
 What happens when someone wants to create a new discretization scheme that's not on the list? She has to add the diffusion implementation directly into the HestonProcess class.  </p>
<p>A better approach might be to allow the user to build her own discretization in
Python and then "compile-down" to C++ in the similar way to how the finite
difference stencils are created in Devito [see my earlier post]
This may just be hopeful speculation on my part :).  Until next time.</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://twitter.com/kevinmgivens"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
    <li class="list-group-item"><a href="https://www.linkedin.com/pub/kevin-m-givens/47/844/275"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="https://github.com/kevingivens"><i class="fa fa-github-square fa-lg"></i> github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Categories -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4>
  <ul class="list-group" id="categories">
    <li class="list-group-item">
      <a href="/category/coding.html"><i class="fa fa-folder-open fa-lg"></i>Coding</a>
    </li>
    <li class="list-group-item">
      <a href="/category/finance.html"><i class="fa fa-folder-open fa-lg"></i>Finance</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Categories -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Kevin Givens
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>




</body>
</html>