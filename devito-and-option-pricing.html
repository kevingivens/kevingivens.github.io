<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Devito and Option Pricing - Lost in the Lyceum</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="/theme/images/icons/favicon.ico" rel="icon">

<link rel="canonical" href="/devito-and-option-pricing.html">

        <meta name="author" content="Kevin Givens" />
        <meta name="keywords" content="Numerical Methods" />
        <meta name="description" content="Summary: Devito allows users to build finite difference schemes in python and &#34;compile-down&#34; to optimized C++ Finite difference methods have a long history in quantitative finance. They are the preferred technique to price and risk manage instruments based on low dimensional probabilistic models that lack analytic solutions. To implement the …" />

        <meta property="og:site_name" content="Lost in the Lyceum" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Devito and Option Pricing"/>
        <meta property="og:url" content="/devito-and-option-pricing.html"/>
        <meta property="og:description" content="Summary: Devito allows users to build finite difference schemes in python and &#34;compile-down&#34; to optimized C++ Finite difference methods have a long history in quantitative finance. They are the preferred technique to price and risk manage instruments based on low dimensional probabilistic models that lack analytic solutions. To implement the …"/>
        <meta property="article:published_time" content="2018-03-04" />
            <meta property="article:section" content="Finance" />
            <meta property="article:tag" content="Numerical Methods" />
            <meta property="article:author" content="Kevin Givens" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/paraiso-dark.css" rel="stylesheet">
    <link href="/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>



</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Lost in the Lyceum            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="/pages/about.html">
                             About
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/devito-and-option-pricing.html"
                       rel="bookmark"
                       title="Permalink to Devito and Option Pricing">
                        Devito and Option Pricing
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-03-04T10:20:00-05:00"> Sun 04 March 2018</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="/tag/numerical-methods.html">Numerical Methods</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Summary: Devito allows users to build finite difference schemes in python and "compile-down" to optimized C++</p>
<p>Finite difference methods have a long history in quantitative finance.  They are the preferred technique to price and risk manage instruments based on low dimensional probabilistic models that lack analytic solutions.  To implement the finite difference method, one chooses a discretization scheme (or stencil) that approximates the derivatives in the model.  This scheme converts a system of differential equations into a system of algebraic equations that can be solved numerically.</p>
<p>Naturally, a scheme introduces error into the calculation that is roughly proportional to the order of the discretization.  Higher order schemes decrease the error in the system but are more difficult to implement by hand in compiled numerical code. Most option pricing libraries provide utilities for building common, low-order schemes. For instance, QuantLib provides forward, backward and central difference operators that can be combined to build a finite difference pricing engine for a given model.</p>
<p>A new python library called <a href="http://www.opesci.org/devito-public">Devito</a> takes a different approach to finite difference model building.  Instead of building a discretization scheme directly in C++, it instead allows users to build an arbitrary scheme in python and "compile" that scheme down to optimized C++.  This code can either be JIT compiled and executed immediately or retained for later execution.</p>
<p>In order to make this approach possible, Devito leverages Sympy, the python-based computer algebra system.  Devito uses Sympy to algebraically manipulate the system of differential equations and generates the equivalent stencil equations used in the numerical implementation.  It then generates optimized C++ code after passing the stencil equations through various optimization algorithms.    </p>
<p>This approach is equivalent to what happens in a compiler.  To wit, "high-level" code is parsed, passed through optimization algorithms and printed down to "low-level" code.  In this example, python is the high level code and C++ is the low level code.</p>
<p>This approach has several advantages; one, the python implementation is close to the mathematical language; two, the often tedious algebraic manipulations needed to build the stencil is off-loaded to the computer algebra system (Sympy); three, the C++ implementation can be highly optimized of efficient computation.</p>
<h3>Black Scholes Equation</h3>
<p>As a first example, let's implement a finite difference solution of the Black Scholes model, the Hello World of quant finance. The Black Scholes PDE for a European option with strike, K, spot, S, volatility <span class="math">\(\sigma\)</span>, risk free rate, r, expiring at T, is given by</p>
<div class="math">$$
\frac{\partial V}{\partial t} + \frac{\sigma^2S^2}{2}\frac{\partial ^2 V}{\partial S^2} + rS\frac{\partial V}{\partial S} - rV = 0
$$</div>
<p>with the terminal condition for a Call option given by</p>
<div class="math">$$V(S,T) = \max(S-K,0)$$</div>
<p>This PDE can be solved analytically:</p>
<div class="math">$$V(S,K,t,r, \sigma)=SN(d_1)−Ke^{−rt}N(d_2)$$</div>
<div class="math">$$d_1=\frac{\ln\left(\frac{S}{K}\right)+\left(r+0.5\sigma^2\right)T}{\sigma\sqrt{T}}\,\,\,d_2=d_1−\sigma\sqrt{T}$$</div>
<p>In Numpy, this pricing function is</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">#Black Scholes Formula</span>
<span class="k">def</span> <span class="nf">d1</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0</span><span class="o">/</span><span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">d2</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0</span><span class="o">/</span><span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">BlackScholes</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">S0</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span> <span class="o">-</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
</pre></div>


<h3>BS Finite Difference Scheme in Numpy</h3>
<p>In order to solve the BS PDE using finite difference techniques, we need to choose a discretization scheme. Keeping things simple, we choose central differences in space and forward differencing in time.  Indexing the spatial dimension with <span class="math">\(i\)</span> and the temporal dimension with <span class="math">\(n\)</span>, Black Scholes PDE  then becomes</p>
<div class="math">$$V_{i}^{n+1} = V_{i}^n - \frac{\sigma^2 (i\Delta S)^2 \Delta t}{2\Delta S^2}\left(V_{i+1}^n - 2 V_{i}^n + V_{i-1}^n\right) - r(i\Delta S)\frac{\sigma \Delta t}{2\Delta S}\left(V_{i+1}^n- V_{i-1}^n \right) + r \Delta t V_{i}^n$$</div>
<div class="math">$$ = V_{i}^n - \frac{\sigma^2 (i)^2 \Delta t}{2}\left(V_{i+1}^n - 2 V_{i}^n + V_{i-1}^n\right) -r(i)\frac{\sigma\Delta t}{2}\left(V_{i+1}^n- V_{i-1}^n \right)+ r \Delta t V_{i}^n
$$</div>
<p>Let's first implement a Numpy version of the scheme for comparison's sake. The numerical algorithm essentially works as follows</p>
<ol>
<li>Evaluate the pricing function at the boundary (payoff)</li>
<li>Iterate backwards in time, solving the difference equation at each iteration</li>
<li>Terminate at t=0 (the evaluation date) to obtain the present value (PV)</li>
</ol>
<p>In terms of data structures, all we need in order to implement this algorithm is two Numpy array buffers.</p>
<h4>A word on spatial boundary conditions</h4>
<p>We need to choose spatial boundary conditions on pricing function.  In practice, this means enforcing some conditions on either the pricing function itself or derivatives of the pricing function.  Following <a href="https://www.amazon.com/Paul-Wilmott-Quantitative-Finance-Set/dp/0470018704">Wilmott Vol 3</a>, we choose the following boundary conditions</p>
<ol>
<li>For <span class="math">\(S = 0 \;\; \frac{\partial V}{\partial t}(0,t) - rV(0,t) = 0\)</span></li>
</ol>
<p>In discrete form this becomes:
</p>
<div class="math">$$V_n^0 = (1 - r \delta t) V_{k-1}^0$$</div>
<ol>
<li>For <span class="math">\(S = S_{max}\;\; \frac{\partial^2 V}{\partial S^2}(S,t) = 0\)</span></li>
</ol>
<p>In discrete form this becomes:
</p>
<div class="math">$$V_n^i = 2V_n^{i-1} - V_n^{i-2}$$</div>
<p>In principle, one can choose different boundary conditions without greatly effecting the computed pricing functions.  For the remaining variables needed to solve the problem we make the following choices</p>
<div class="highlight"><pre><span></span><span class="c1"># Some variable declarations needed for numerical implementation</span>
<span class="n">nx</span> <span class="o">=</span> <span class="mi">20</span>    <span class="c1"># number of space steps</span>
<span class="n">s</span> <span class="o">=</span> <span class="mf">0.2</span>    <span class="c1"># vol</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.05</span>   <span class="c1"># interest rate</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">1</span>      <span class="c1"># time to expiry</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">100</span>    <span class="c1"># Strike</span>
<span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.9</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">nx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># time step size</span>
<span class="n">nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># number of time steps</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">nt</span>
<span class="n">dx</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">K</span><span class="o">/</span><span class="n">nx</span>
</pre></div>


<p>Defining a Call payoff function and initializing it at the t=T boundary</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">payoff</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">K</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">S</span><span class="o">-</span><span class="n">K</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="n">v_payoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">payoff</span><span class="p">)</span>
<span class="n">v_bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">BlackScholes</span><span class="p">)</span>

<span class="c1"># Init C at the payoff</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span><span class="n">dx</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">v_payoff</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">K</span><span class="p">)</span>
</pre></div>


<p>Now we can define a diffuse function that carries out the finite difference algorithm. Here we name our pricing function <code>C</code> for Call in order to distinguish it from <code>V</code> used below in the Devito implementation.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">diffuse</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">nt</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
        <span class="n">Cn</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Cn</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="n">Cn</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">Cn</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Cn</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Cn</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">delta</span><span class="p">)</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">Cn</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cn</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dt</span><span class="o">*</span><span class="n">theta</span>
        <span class="c1">#spatial bc&#39;s</span>
        <span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">C</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">C</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
</pre></div>


<p>With our implementation in place, let's diffuse the model back 10 time steps.</p>
<div class="highlight"><pre><span></span><span class="n">diffuse</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">nt</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>


<p>Comparing this to analytic solution to BS gives</p>
<div class="highlight"><pre><span></span><span class="n">C</span>
</pre></div>


<div class="highlight"><pre><span></span>array([  0.00000000e+00,   6.77083365e-15,   2.47797465e-11,
         1.38986768e-08,   2.31379196e-06,   1.50919507e-04,
         4.48551091e-03,   6.67669285e-02,   5.33585468e-01,
         2.44970519e+00,   7.05423863e+00,   1.43368053e+01,
         2.32467881e+01,   3.28816476e+01,   4.27765661e+01,
         5.27502671e+01,   6.27445527e+01,   7.27434913e+01,
         8.27433082e+01,   9.27431251e+01,   1.00000000e+02])
</pre></div>


<div class="highlight"><pre><span></span><span class="n">v_bs</span><span class="p">(</span><span class="n">S0</span><span class="o">=</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>array([  0.00000000e+00,   2.13184792e-53,   8.12368101e-27,
         1.49012572e-15,   1.86102962e-09,   8.60357129e-06,
         1.81033147e-03,   5.89084888e-02,   5.84232552e-01,
         2.66791893e+00,   7.33121846e+00,   1.45076224e+01,
         2.33168378e+01,   3.29033374e+01,   4.27809370e+01,
         5.27490737e+01,   6.27415850e+01,   7.27399614e+01,
         8.27396309e+01,   9.27395669e+01,   1.02739555e+02])
</pre></div>


<p>Plotting the PV gives reasonable looking results</p>
<div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="/blackscholes_devito_files/blackscholes_devito_19_1.png"></p>
<h2>Devito Implementation</h2>
<p>Now we want to implement the same model in Devito. First, a brief word about the Devito API. (For more info, consult the Devito documentation)  </p>
<p>A key idea in Devito is to present users with a <code>Function</code> object that has dual identity, one symbolic and the other numeric.  That is, <code>Function</code> objects can be manipulated by Sympy in order to generate the stencil equations. Later, when the finite difference scheme is being numerically solved, <code>Function</code> objects hold numerical data in two Numpy array buffers in similar way to how data was stored during the Numpy implementation given above.  This dual approach allows users to implement and solve the finite difference problems in a natural way.  They don't have to implement and reason about separate data structures for the differential equations as well as the numerical implementation.</p>
<p>For our implementation, we first need to declare instances of <code>Grid</code>, <code>Function</code> and <code>TimeFunction</code> (time varying function).  We then define the stencil equation using the <code>TimeFunction</code> <code>V</code>'s Sympy identity.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">devito</span> <span class="kn">import</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">TimeFunction</span><span class="p">,</span> <span class="n">Function</span><span class="p">,</span> <span class="n">Operator</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Eq</span><span class="p">,</span> <span class="n">solve</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Initialize `u` for space order 2</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">,),</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mf">200.</span><span class="p">,))</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">TimeFunction</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">space_order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>

<span class="c1"># Create an equation with second-order derivatives</span>
<span class="n">eq</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">X</span><span class="o">*</span><span class="n">X</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">dx2</span><span class="p">)</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">X</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">V</span><span class="p">)</span>
<span class="n">stencil</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">forward</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">eq_stencil</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span> <span class="n">stencil</span><span class="p">)</span>
</pre></div>


<p>Looking at the stencil, one can see that it is equivalent to the Numpy version of the stencil defined earlier.</p>
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">stencil</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>(0.025*dt*h_x*(-V(t, x - h_x) + V(t, x + h_x))*X(x) + 0.02*dt*(-2.0*V(t, x) + V(t, x - h_x) + V(t, x + h_x))*X(x)**2 + 0.05*h_x**2*(-dt + 20.0)*V(t, x))/h_x**2
</pre></div>


<p>Next we implement boundary conditions by setting the <code>Data</code> attribute of V equal to the payoff value.  We also enforce spatial boundary conditions as before.  Finally, we construct an <code>Operator</code> object from the stencil and boundary conditions.  This is the object that carries out the diffusion in order to solve the finite difference problem.</p>
<div class="highlight"><pre><span></span><span class="c1"># Init C at the payoff</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span><span class="n">dx</span><span class="p">)</span>
<span class="n">V</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_payoff</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">K</span><span class="p">)</span>
<span class="n">V</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_payoff</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="n">K</span><span class="p">)</span>
<span class="n">X</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">S</span>

<span class="c1"># Create boundary condition expressions</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">dimensions</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">stepping_dim</span>
<span class="n">bc</span> <span class="o">=</span> <span class="p">[</span><span class="n">Eq</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">indexed</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">V</span><span class="o">.</span><span class="n">indexed</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">dt</span><span class="p">))]</span>  <span class="c1"># bottom</span>
<span class="n">bc</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Eq</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">indexed</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">V</span><span class="o">.</span><span class="n">indexed</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">V</span><span class="o">.</span><span class="n">indexed</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">])]</span>  <span class="c1"># top</span>

<span class="c1"># Define the operator</span>
<span class="n">op</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">([</span><span class="n">eq_stencil</span><span class="p">]</span> <span class="o">+</span> <span class="n">bc</span><span class="p">)</span>
</pre></div>


<p>The data arrays before simulation are initialized to the payoff boundary</p>
<div class="highlight"><pre><span></span><span class="n">V</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span>array([   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
          0.,    0.,   10.,   20.,   30.,   40.,   50.,   60.,   70.,
         80.,   90.,  100.], dtype=float32)
</pre></div>


<p>Diffusing the operator 10 time steps as before we get</p>
<div class="highlight"><pre><span></span><span class="n">op</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">CustomCompiler</span><span class="o">:</span> <span class="n">compiled</span> <span class="sr">/tmp/devito-oebkv76j/</span><span class="mi">41</span><span class="n">acee72a2d7a564a563c14bcd4b5358a3ed3147</span><span class="o">.</span><span class="na">c</span> <span class="o">[</span><span class="mf">1.23</span> <span class="n">s</span><span class="o">]</span>
<span class="o">=========================================================================================</span>
<span class="n">Section</span> <span class="n">section_0</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">,</span><span class="mi">20</span><span class="o">&gt;</span> <span class="k">with</span> <span class="n">OI</span><span class="o">=</span><span class="mf">1.44</span> <span class="n">computed</span> <span class="k">in</span> <span class="mf">0.000</span> <span class="n">s</span> <span class="o">[</span><span class="mf">4.00</span> <span class="n">GFlops</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>
<span class="n">Section</span> <span class="n">main</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="k">with</span> <span class="n">OI</span><span class="o">=</span><span class="mf">1.67</span> <span class="n">computed</span> <span class="k">in</span> <span class="mf">0.000</span> <span class="n">s</span> <span class="o">[</span><span class="mf">0.11</span> <span class="n">GFlops</span><span class="sr">/s, 0.01 GPts/s</span><span class="o">]</span>
<span class="o">=========================================================================================</span>
</pre></div>


<p>Now let's inspect the data array</p>
<div class="highlight"><pre><span></span><span class="n">V</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span>array([  0.00000000e+00,   6.77083621e-15,   2.47797494e-11,
         1.38986778e-08,   2.31379227e-06,   1.50919528e-04,
         4.48551122e-03,   6.67669326e-02,   5.33585429e-01,
         2.44970512e+00,   7.05423832e+00,   1.43368015e+01,
         2.32467213e+01,   3.28807259e+01,   4.27697105e+01,
         5.27169189e+01,   6.26308594e+01,   7.24206314e+01,
         8.20446320e+01,   9.12274399e+01,   1.00405121e+02], dtype=float32)
</pre></div>


<p>Comparing that with the Numpy implementation gives similar results</p>
<div class="highlight"><pre><span></span><span class="n">C</span>
</pre></div>


<div class="highlight"><pre><span></span>array([  0.00000000e+00,   6.77083365e-15,   2.47797465e-11,
         1.38986768e-08,   2.31379196e-06,   1.50919507e-04,
         4.48551091e-03,   6.67669285e-02,   5.33585468e-01,
         2.44970519e+00,   7.05423863e+00,   1.43368053e+01,
         2.32467881e+01,   3.28816476e+01,   4.27765661e+01,
         5.27502671e+01,   6.27445527e+01,   7.27434913e+01,
         8.27433082e+01,   9.27431251e+01,   1.00000000e+02])
</pre></div>


<p>As one can see from the results, the closest agreement between all three solutions is away from the boundaries and the cusp S = K.<br>
This makes sense as the pricing function isn't smooth at those points.  I will explore the numerical errors in a later post.</p>
<p>For fun, let's you can take a look at the C++ code that was generated and JIT compiled during evaluation</p>
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">ccode</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>    <span class="cp">#define _POSIX_C_SOURCE 200809L</span>
    <span class="cp">#include</span> <span class="cpf">&quot;stdlib.h&quot;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&quot;math.h&quot;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&quot;sys/time.h&quot;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&quot;xmmintrin.h&quot;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&quot;pmmintrin.h&quot;</span><span class="cp"></span>

    <span class="k">struct</span> <span class="n">profile</span>
    <span class="p">{</span>
      <span class="kt">double</span> <span class="n">section_0</span><span class="p">;</span>
      <span class="kt">double</span> <span class="n">section_1</span><span class="p">;</span>
    <span class="p">}</span> <span class="p">;</span>


    <span class="kt">int</span> <span class="nf">Kernel</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">V_vec</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">X_vec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">dt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">h_x</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">t_size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">t_s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">t_e</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">time_size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">time_s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">time_e</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">x_size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">x_s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">x_e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_timings</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">float</span> <span class="p">(</span><span class="o">*</span><span class="kr">restrict</span> <span class="n">V</span><span class="p">)[</span><span class="n">x_size</span><span class="p">]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="p">(</span><span class="o">*</span><span class="p">)[</span><span class="n">x_size</span><span class="p">])</span> <span class="n">V_vec</span><span class="p">;</span>
      <span class="kt">float</span> <span class="p">(</span><span class="o">*</span><span class="kr">restrict</span> <span class="n">X</span><span class="p">)</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="p">(</span><span class="o">*</span><span class="p">))</span> <span class="n">X_vec</span><span class="p">;</span>
      <span class="k">struct</span> <span class="n">profile</span> <span class="o">*</span><span class="n">timings</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">profile</span><span class="o">*</span><span class="p">)</span> <span class="n">_timings</span><span class="p">;</span>
      <span class="cm">/* Flush denormal numbers to zero in hardware */</span>
      <span class="n">_MM_SET_DENORMALS_ZERO_MODE</span><span class="p">(</span><span class="n">_MM_DENORMALS_ZERO_ON</span><span class="p">);</span>
      <span class="n">_MM_SET_FLUSH_ZERO_MODE</span><span class="p">(</span><span class="n">_MM_FLUSH_ZERO_ON</span><span class="p">);</span>
      <span class="k">struct</span> <span class="n">timeval</span> <span class="n">start_section_1</span><span class="p">,</span> <span class="n">end_section_1</span><span class="p">;</span>
      <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_section_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="n">t_s</span><span class="p">,</span> <span class="n">t0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="n">t_e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">time</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x_s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">x_e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">V</span><span class="p">[</span><span class="n">t1</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.5e-2</span><span class="n">F</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">h_x</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">V</span><span class="p">[</span><span class="n">t0</span><span class="p">][</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">V</span><span class="p">[</span><span class="n">t0</span><span class="p">][</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0e-2</span><span class="n">F</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0F</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="n">t0</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">V</span><span class="p">[</span><span class="n">t0</span><span class="p">][</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">V</span><span class="p">[</span><span class="n">t0</span><span class="p">][</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mf">5.0e-2</span><span class="n">F</span><span class="o">*</span><span class="p">(</span><span class="n">h_x</span><span class="o">*</span><span class="n">h_x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dt</span> <span class="o">+</span> <span class="mf">2.0e+1</span><span class="n">F</span><span class="p">)</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="n">t0</span><span class="p">][</span><span class="n">x</span><span class="p">])</span><span class="o">/</span><span class="n">pow</span><span class="p">(</span><span class="n">h_x</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">V</span><span class="p">[</span><span class="n">t1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">9.97222222222222e-1</span><span class="n">F</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="n">t0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">V</span><span class="p">[</span><span class="n">t1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">V</span><span class="p">[</span><span class="n">t1</span><span class="p">][</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="n">t1</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end_section_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="n">timings</span><span class="o">-&gt;</span><span class="n">section_1</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">end_section_1</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">-</span><span class="n">start_section_1</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">end_section_1</span><span class="p">.</span><span class="n">tv_usec</span><span class="o">-</span><span class="n">start_section_1</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>


<h2>Conclusion</h2>
<p>In this post we solved Black Scholes equation using finite difference methods in both Numpy and Devito.  As you can see, their output is similar but their implementation is different.  The great thing about Devito is that it allows users to build complex stencils and solve pde's without having to worry about hand writing optimized C++ code.  This achieves a nice seperation of concerns between model building in Python and numerical implemenation in C++.  </p>
<p>In future posts, I plan on implementing more finance models in Devito and comparing Devito's performance with conventional pricing libraries like QuantLib.  Until then, thanks for visiting my blog.  See you next time.</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://twitter.com/kevinmgivens"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
    <li class="list-group-item"><a href="https://www.linkedin.com/pub/kevin-m-givens/47/844/275"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="https://github.com/kevingivens"><i class="fa fa-github-square fa-lg"></i> github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Categories -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4>
  <ul class="list-group" id="categories">
    <li class="list-group-item">
      <a href="/category/finance.html"><i class="fa fa-folder-open fa-lg"></i>Finance</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Categories -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Kevin Givens
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>




</body>
</html>